##This is for importing the annual birth certificate data, which usually arrives in March
#Source: Minnesota Dept of health
#Need to do some cleanup and prep in the source file; it usually comes as Excel
#dates have been problematic in years past --   10-JUN-00  -- needs to be converted to mm/dd/yyyy

CREATE TABLE `births_temp` (
  `ST_FILE_NBR` varchar(50) DEFAULT NULL,
  `MTHR_DESIGNATED_PUBLIC` varchar(50) DEFAULT NULL,
  `CHLD_FRST_NME` varchar(50) DEFAULT NULL,
  `CHLD_MIDD_NME` varchar(50) DEFAULT NULL,
  `CHLD_LST_NME` varchar(50) DEFAULT NULL,
  `CHLD_SFX_NME` varchar(50) DEFAULT NULL,
  `CHLD_BRTH_DT` datetime DEFAULT NULL,
  `CHLD_BRTH_TM` varchar(50) DEFAULT NULL,
  `CHLD_BRTH_TM_IND` varchar(50) DEFAULT NULL,
  `CHLD_SEX` varchar(50) DEFAULT NULL,
  `BRTH_PLRLTY` int(11) DEFAULT NULL,
  `BRTH_PLRLTY_LIVE` varchar(50) DEFAULT NULL,
  `BRTH_ORDR` varchar(50) DEFAULT NULL,
  `BRTH_STRT` varchar(255) DEFAULT NULL,
  `BRTH_MLTIUNIT` varchar(50) DEFAULT NULL,
  `BRTH_CTY` varchar(50) DEFAULT NULL,
  `BRTH_ST` varchar(50) DEFAULT NULL,
  `BRTH_ZIP5` varchar(50) DEFAULT NULL,
  `BRTH_ZIP4` varchar(50) DEFAULT NULL,
  `BRTH_CNTRY` varchar(50) DEFAULT NULL,
  `BRTH_CNTY` varchar(50) DEFAULT NULL,
  `PLC_BRTH_TYPE` varchar(50) DEFAULT NULL,
  `PLC_BRTH_TYPE_OTHR` varchar(50) DEFAULT NULL,
  `PLC_BRTH_FCLTY_NME` varchar(50) DEFAULT NULL,
  `PLCE_BRTH_FCLTY_ID` varchar(50) DEFAULT NULL,
  `ATND_FRST_NME` varchar(50) DEFAULT NULL,
  `ATND_MIDD_NME` varchar(50) DEFAULT NULL,
  `ATND_LST_NME` varchar(50) DEFAULT NULL,
  `ATND_TITLE` varchar(50) DEFAULT NULL,
  `ATND_TITLE_OTHR` varchar(50) DEFAULT NULL,
  `ATND_LIC_NBR` varchar(50) DEFAULT NULL,
  `ATND_ADDR_STRT` varchar(255) DEFAULT NULL,
  `ATND_ADDR_MLTIUNIT` varchar(50) DEFAULT NULL,
  `ATND_ADDR_CTY` varchar(50) DEFAULT NULL,
  `ATND_ADDR_ZIP5` varchar(50) DEFAULT NULL,
  `ATND_ADDR_ZIP4` varchar(50) DEFAULT NULL,
  `ATND_ADDR_ST` varchar(50) DEFAULT NULL,
  `ATND_ADDR_CNTRY` varchar(50) DEFAULT NULL,
  `MTHR_FRST_NME` varchar(50) DEFAULT NULL,
  `MTHR_MIDD_NME` varchar(50) DEFAULT NULL,
  `MTHR_LST_NME` varchar(50) DEFAULT NULL,
  `MTHR_SFX_NME` varchar(50) DEFAULT NULL,
  `MTHR_MAIDN_FRST_NME` varchar(50) DEFAULT NULL,
  `MTHR_MAIDN_MIDD_NME` varchar(50) DEFAULT NULL,
  `MTHR_MAIDN_LST_NME` varchar(50) DEFAULT NULL,
  `MTHR_MAIDN_SFX_NME` varchar(50) DEFAULT NULL,
  `MTHR_BRTH_DT` datetime DEFAULT NULL,
  `MTHR_AGE` int(11) DEFAULT NULL,
  `MTHR_BRTH_CTY` varchar(50) DEFAULT NULL,
  `MTHR_BRTH_CTY_OTHR` varchar(50) DEFAULT NULL,
  `MTHR_BRTH_ST` varchar(50) DEFAULT NULL,
  `MTHR_BRTH_CNTRY` varchar(50) DEFAULT NULL,
  `MTHR_BRTH_CNTRY_OTHR` varchar(50) DEFAULT NULL,
  `MTHR_RES_STRT` varchar(255) DEFAULT NULL,
  `MTHR_RES_MLTIUNIT` varchar(50) DEFAULT NULL,
  `MTHR_RES_CTY` varchar(50) DEFAULT NULL,
  `MTHR_RES_CTY_OTHR` varchar(50) DEFAULT NULL,
  `MTHR_RES_ZIP5` varchar(50) DEFAULT NULL,
  `MTHR_RES_ZIP4` varchar(50) DEFAULT NULL,
  `MTHR_RES_ST` varchar(50) DEFAULT NULL,
  `MTHR_RES_CNTRY` varchar(50) DEFAULT NULL,
  `MTHR_RES_CNTRY_OTHR` varchar(50) DEFAULT NULL,
  `MTHR_RES_CNTY` varchar(50) DEFAULT NULL,
  `MTHR_RES_CTY_LIMITS` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_STRT` varchar(255) DEFAULT NULL,
  `MTHR_MAIL_MLTIUNIT` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_CTY` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_ST` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_ZIP5` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_ZIP4` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_CNTRY` varchar(50) DEFAULT NULL,
  `MTHR_MAIL_CNTY` varchar(50) DEFAULT NULL,
  `FTHR_FRST_NME` varchar(50) DEFAULT NULL,
  `FTHR_MIDD_NME` varchar(50) DEFAULT NULL,
  `FTHR_LST_NME` varchar(50) DEFAULT NULL,
  `FTHR_SFX_NME` varchar(50) DEFAULT NULL,
  `FTHR_BRTH_DT` datetime DEFAULT NULL,
  `FTHR_AGE` int(11) DEFAULT NULL,
  `FTHR_BRTH_CTY` varchar(50) DEFAULT NULL,
  `FTHR_BRTH_CTY_OTHR` varchar(50) DEFAULT NULL,
  `FTHR_BRTH_ST` varchar(50) DEFAULT NULL,
  `FTHR_BRTH_CNTRY` varchar(50) DEFAULT NULL,
  `FTHR_BRTH_CNTRY_OTHR` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_STRT` varchar(255) DEFAULT NULL,
  `FTHR_MAIL_MLTIUNIT` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_CTY` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_ST` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_ZIP5` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_ZIP4` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_CNTRY` varchar(50) DEFAULT NULL,
  `FTHR_MAIL_CNTY` varchar(50) DEFAULT NULL,
  `MTHR_MARRIED` varchar(50) DEFAULT NULL,
  `DT_FILED` datetime DEFAULT NULL,
  `BirthYear` smallint(6) DEFAULT NULL,
`stribimportdate` datetime,
  KEY `IX_childlast` (`CHLD_LST_NME`),
  KEY `IX_childfirst` (`CHLD_FRST_NME`),
  KEY `IX_childmiddle` (`CHLD_MIDD_NME`),
  KEY `IX_childdob` (`CHLD_BRTH_DT`),
  KEY `IX_birthyear` (`BirthYear`),
  KEY `IX_motherlast` (`MTHR_LST_NME`),
  KEY `IX_motherfirst` (`MTHR_FRST_NME`),
  KEY `IX_mothermidd` (`MTHR_MIDD_NME`),
  KEY `IX_fatherlast` (`FTHR_LST_NME`),
  KEY `IX_fatherfirst` (`FTHR_FRST_NME`),
  KEY `IX_residence` (`MTHR_RES_STRT`),
  KEY `IX_city` (`MTHR_RES_CTY`),
  KEY `IX_state` (`MTHR_RES_ST`),
  KEY `IX_zip` (`MTHR_RES_ZIP5`),
  KEY `IX_maiden` (`MTHR_MAIDN_LST_NME`),
  KEY `IX_st_file_nbr` (`ST_FILE_NBR`),
  KEY `_WA_Sys_ATND_LST_NME_5A846E65` (`ATND_LST_NME`),
  KEY `_WA_Sys_ATND_FRST_NME_5A846E65` (`ATND_FRST_NME`),
  KEY `idx_MTHR_MARRIED` (`MTHR_MARRIED`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1

;

LOAD DATA LOCAL INFILE 'W:\\Uniquery_PANDA\\VitalRecords\\Births2017_newheaders.csv' into table births_temp fields terminated by ',' enclosed by '"' lines terminated by '\r\n' ignore 1 lines
(@ST_FILE_NBR,
@MTHR_DESIGNATED_PUBLIC,
@CHLD_FRST_NME,
@CHLD_MIDD_NME,
@CHLD_LST_NME,
@CHLD_SFX_NME,
@CHLD_BRTH_DT,
@CHLD_BRTH_TM,
@CHLD_BRTH_TM_IND,
@CHLD_SEX,
@BRTH_PLRLTY,
@BRTH_PLRLTY_LIVE,
@BRTH_ORDR,
@BRTH_STRT,
@BRTH_MLTIUNIT,
@BRTH_CTY,
@BRTH_ST,
@BRTH_ZIP5,
@BRTH_ZIP4,
@BRTH_CNTRY,
@BRTH_CNTY,
@PLC_BRTH_TYPE,
@PLC_BRTH_TYPE_OTHR,
@PLC_BRTH_FCLTY_NME,
@PLCE_BRTH_FCLTY_ID,
@ATND_FRST_NME,
@ATND_MIDD_NME,
@ATND_LST_NME,
@ATND_TITLE,
@ATND_TITLE_OTHR,
@ATND_LIC_NBR,
@ATND_ADDR_STRT,
@ATND_ADDR_MLTIUNIT,
@ATND_ADDR_CTY,
@ATND_ADDR_ZIP5,
@ATND_ADDR_ZIP4,
@ATND_ADDR_ST,
@ATND_ADDR_CNTRY,
@MTHR_FRST_NME,
@MTHR_MIDD_NME,
@MTHR_LST_NME,
@MTHR_SFX_NME,
@MTHR_MAIDN_FRST_NME,
@MTHR_MAIDN_MIDD_NME,
@MTHR_MAIDN_LST_NME,
@MTHR_MAIDN_SFX_NME,
@MTHR_BRTH_DT,
@MTHR_AGE,
@MTHR_BRTH_CTY,
@MTHR_BRTH_CTY_OTHR,
@MTHR_BRTH_ST,
@MTHR_BRTH_CNTRY,
@MTHR_BRTH_CNTRY_OTHR,
@MTHR_RES_STRT,
@MTHR_RES_MLTIUNIT,
@MTHR_RES_CTY,
@MTHR_RES_CTY_OTHR,
@MTHR_RES_ZIP5,
@MTHR_RES_ZIP4,
@MTHR_RES_ST,
@MTHR_RES_CNTRY,
@MTHR_RES_CNTRY_OTHR,
@MTHR_RES_CNTY,
@MTHR_RES_CTY_LIMITS,
@MTHR_MAIL_STRT,
@MTHR_MAIL_MLTIUNIT,
@MTHR_MAIL_CTY,
@MTHR_MAIL_ST,
@MTHR_MAIL_ZIP5,
@MTHR_MAIL_ZIP4,
@MTHR_MAIL_CNTRY,
@MTHR_MAIL_CNTY,
@FTHR_FRST_NME,
@FTHR_MIDD_NME,
@FTHR_LST_NME,
@FTHR_SFX_NME,
@FTHR_BRTH_DT,
@FTHR_AGE,
@FTHR_BRTH_CTY,
@FTHR_BRTH_CTY_OTHR,
@FTHR_BRTH_ST,
@FTHR_BRTH_CNTRY,
@FTHR_BRTH_CNTRY_OTHR,
@FTHR_MAIL_STRT,
@FTHR_MAIL_MLTIUNIT,
@FTHR_MAIL_CTY,
@FTHR_MAIL_ST,
@FTHR_MAIL_ZIP5,
@FTHR_MAIL_ZIP4,
@FTHR_MAIL_CNTRY,
@FTHR_MAIL_CNTY,
@MTHR_MARRIED,
@DT_FILED)
SET
ST_FILE_NBR=@ST_FILE_NBR,
MTHR_DESIGNATED_PUBLIC=@MTHR_DESIGNATED_PUBLIC,
CHLD_FRST_NME=@CHLD_FRST_NME,
CHLD_MIDD_NME=@CHLD_MIDD_NME,
CHLD_LST_NME=@CHLD_LST_NME,
CHLD_SFX_NME=@CHLD_SFX_NME,
CHLD_BRTH_DT=STR_TO_DATE(@CHLD_BRTH_DT, '%m/%d/%Y'),
CHLD_BRTH_TM=@CHLD_BRTH_TM,
CHLD_BRTH_TM_IND=@CHLD_BRTH_TM_IND,
CHLD_SEX=@CHLD_SEX,
BRTH_PLRLTY=@BRTH_PLRLTY,
BRTH_PLRLTY_LIVE=@BRTH_PLRLTY_LIVE,
BRTH_ORDR=@BRTH_ORDR,
BRTH_STRT=@BRTH_STRT,
BRTH_MLTIUNIT=@BRTH_MLTIUNIT,
BRTH_CTY=@BRTH_CTY,
BRTH_ST=@BRTH_ST,
BRTH_ZIP5=@BRTH_ZIP5,
BRTH_ZIP4=@BRTH_ZIP4,
BRTH_CNTRY=@BRTH_CNTRY,
BRTH_CNTY=@BRTH_CNTY,
PLC_BRTH_TYPE=@PLC_BRTH_TYPE,
PLC_BRTH_TYPE_OTHR=@PLC_BRTH_TYPE_OTHR,
PLC_BRTH_FCLTY_NME=@PLC_BRTH_FCLTY_NME,
PLCE_BRTH_FCLTY_ID=@PLCE_BRTH_FCLTY_ID,
ATND_FRST_NME=@ATND_FRST_NME,
ATND_MIDD_NME=@ATND_MIDD_NME,
ATND_LST_NME=@ATND_LST_NME,
ATND_TITLE=@ATND_TITLE,
ATND_TITLE_OTHR=@ATND_TITLE_OTHR,
ATND_LIC_NBR=@ATND_LIC_NBR,
ATND_ADDR_STRT=@ATND_ADDR_STRT,
ATND_ADDR_MLTIUNIT=@ATND_ADDR_MLTIUNIT,
ATND_ADDR_CTY=@ATND_ADDR_CTY,
ATND_ADDR_ZIP5=@ATND_ADDR_ZIP5,
ATND_ADDR_ZIP4=@ATND_ADDR_ZIP4,
ATND_ADDR_ST=@ATND_ADDR_ST,
ATND_ADDR_CNTRY=@ATND_ADDR_CNTRY,
MTHR_FRST_NME=@MTHR_FRST_NME,
MTHR_MIDD_NME=@MTHR_MIDD_NME,
MTHR_LST_NME=@MTHR_LST_NME,
MTHR_SFX_NME=@MTHR_SFX_NME,
MTHR_MAIDN_FRST_NME=@MTHR_MAIDN_FRST_NME,
MTHR_MAIDN_MIDD_NME=@MTHR_MAIDN_MIDD_NME,
MTHR_MAIDN_LST_NME=@MTHR_MAIDN_LST_NME,
MTHR_MAIDN_SFX_NME=@MTHR_MAIDN_SFX_NME,
MTHR_BRTH_DT=STR_TO_DATE(@MTHR_BRTH_DT, '%m/%d/%Y'),
MTHR_AGE=@MTHR_AGE,
MTHR_BRTH_CTY=@MTHR_BRTH_CTY,
MTHR_BRTH_CTY_OTHR=@MTHR_BRTH_CTY_OTHR,
MTHR_BRTH_ST=@MTHR_BRTH_ST,
MTHR_BRTH_CNTRY=@MTHR_BRTH_CNTRY,
MTHR_BRTH_CNTRY_OTHR=@MTHR_BRTH_CNTRY_OTHR,
MTHR_RES_STRT=@MTHR_RES_STRT,
MTHR_RES_MLTIUNIT=@MTHR_RES_MLTIUNIT,
MTHR_RES_CTY=@MTHR_RES_CTY,
MTHR_RES_CTY_OTHR=@MTHR_RES_CTY_OTHR,
MTHR_RES_ZIP5=@MTHR_RES_ZIP5,
MTHR_RES_ZIP4=@MTHR_RES_ZIP4,
MTHR_RES_ST=@MTHR_RES_ST,
MTHR_RES_CNTRY=@MTHR_RES_CNTRY,
MTHR_RES_CNTRY_OTHR=@MTHR_RES_CNTRY_OTHR,
MTHR_RES_CNTY=@MTHR_RES_CNTY,
MTHR_RES_CTY_LIMITS=@MTHR_RES_CTY_LIMITS,
MTHR_MAIL_STRT=@MTHR_MAIL_STRT,
MTHR_MAIL_MLTIUNIT=@MTHR_MAIL_MLTIUNIT,
MTHR_MAIL_CTY=@MTHR_MAIL_CTY,
MTHR_MAIL_ST=@MTHR_MAIL_ST,
MTHR_MAIL_ZIP5=@MTHR_MAIL_ZIP5,
MTHR_MAIL_ZIP4=@MTHR_MAIL_ZIP4,
MTHR_MAIL_CNTRY=@MTHR_MAIL_CNTRY,
MTHR_MAIL_CNTY=@MTHR_MAIL_CNTY,
FTHR_FRST_NME=@FTHR_FRST_NME,
FTHR_MIDD_NME=@FTHR_MIDD_NME,
FTHR_LST_NME=@FTHR_LST_NME,
FTHR_SFX_NME=@FTHR_SFX_NME,
FTHR_BRTH_DT=STR_TO_DATE(@FTHR_BRTH_DT, '%m/%d/%Y'),
FTHR_AGE=@FTHR_AGE,
FTHR_BRTH_CTY=@FTHR_BRTH_CTY,
FTHR_BRTH_CTY_OTHR=@FTHR_BRTH_CTY_OTHR,
FTHR_BRTH_ST=@FTHR_BRTH_ST,
FTHR_BRTH_CNTRY=@FTHR_BRTH_CNTRY,
FTHR_BRTH_CNTRY_OTHR=@FTHR_BRTH_CNTRY_OTHR,
FTHR_MAIL_STRT=@FTHR_MAIL_STRT,
FTHR_MAIL_MLTIUNIT=@FTHR_MAIL_MLTIUNIT,
FTHR_MAIL_CTY=@FTHR_MAIL_CTY,
FTHR_MAIL_ST=@FTHR_MAIL_ST,
FTHR_MAIL_ZIP5=@FTHR_MAIL_ZIP5,
FTHR_MAIL_ZIP4=@FTHR_MAIL_ZIP4,
FTHR_MAIL_CNTRY=@FTHR_MAIL_CNTRY,
FTHR_MAIL_CNTY=@FTHR_MAIL_CNTY,
MTHR_MARRIED=@MTHR_MARRIED,
DT_FILED=STR_TO_DATE(@DT_FILED, '%m/%d/%Y'),
stribimportdate=NOW()
;

update births_temp set birthyear=year(CHLD_BRTH_DT);

;

##CHECK TO MAKE SURE EVERYTHING FELL INTO THE RIGHT COLUMN;
#RUN  A COUPLE GROUP BY QUERIES TO MAKE SURE IT WORKED

select *
from births_temp
limit 100

;

select fthr_mail_cnty, count(*)
from births_temp
group by fthr_mail_cnty

;

select plc_brth_type, count(*)
from births_temp
group by PLC_BRTH_TYPE



#############################################################################
#UNCOMMENT THE QUERIES BELOW TO INSERT NEW DATA INTO THE MAIN TABLE
insert into births_main
select * from births_temp
;


update newsroomdata.inventory set lastupdate=now() where idnumber=4;

OPTIMIZE TABLE births_main;


######################################################
##getting data to PANDA
#export the births_temp file and add it to the existing records
#it needs to include all the original fields, plus birthyear and stribimportdate
